<!DOCTYPE html>
<html> 
  <head>
    <title>Processing.JS inside Webpages: Template</title> 
  </head>
  <body>
	<!--This draws the canvas on the webpage -->
    <canvas id="mycanvas"></canvas> 
  </body>
 
  <!-- Include the processing.js library -->
  <!-- See https://khanacademy.zendesk.com/hc/en-us/articles/202260404-What-parts-of-ProcessingJS-does-Khan-Academy-support- for differences -->
  <script src="https://cdn.jsdelivr.net/processing.js/1.4.8/processing.min.js"></script> 
  <script>
  var programCode = function(processingInstance) {
    with (processingInstance) {
      size(400, 400); 
      frameRate(60);
        
      // Paste code from Khan Academy here:// The fishBall

// The fishBall

// The left arrow turns it left, the rigth arrow turns it right
// The UP key will restart the code.
// If the tail stops oscillating (with key Z), it will take some seconds to start again

// Fish object or class

angleMode = "radians";
frameRate(60);               //  60

var Fish = function(origin) { 
    
     // related to the fin position
  
    this.aPosition = PI/6;
    this.aVelocity = 0.1;                                  
    this.time = 0;
    this.countUp = true;

    // related to the fish position
    
    this.position =  origin.get();          
    this.velocity = new PVector(0,0);
    this.acceleration = new PVector(0, 0);
    this.linearFriction = 0.95;            // Linear fish friction with water.
    this.fishMass = 10;
    this.isDead = false;
    this.rotateFish = PI/6;
    
};

// Move the fish

Fish.prototype.applyForce = function(force) {
    var f = PVector.div(force, this.fishMass);
    this.acceleration.add(f);
}; 

Fish.prototype.update = function() {
    
    // This part for the fish.
    
    this.velocity.add(this.acceleration);
    this.velocity.mult(this.linearFriction);  // friction
    this.position.add(this.velocity);
    this.acceleration.mult(0);
    
    // This part for the fin
    
    this.aVelocity =  0.1 * this.velocity.mag(); 
    this.aPosition = this.time;
};

// Calculate and apply fin speed

Fish.prototype.connect = function() {                
    
    if (this.time > PI/3)  {
      this.countUp = false;
    }
    if (this.time < -PI/3)  { 
       this.countUp = true;
    }
    if ( this.countUp )  {
         this.time += this.aVelocity;                 
    }
    else {
         this.time -= this.aVelocity;
    }
   
    this.currAngle = this.aPosition;          
};
 
Fish.prototype.display = function(bodyLength, bodyHeight, bodyColor, fishN, finnP, finnColor, rotateFish) {
        
    pushMatrix();
    translate(this.position.x , this.position.y);  
    rotate(rotateFish);                
    noStroke();          
    fill(bodyColor);
    // body
    ellipse(0, 0, bodyLength, bodyHeight);
    // tail
    var tailWidth = bodyLength/4;
    var tailHeight = bodyHeight/2.2;
    this.finnColor = color(200 * this.aPosition, 100, 100) ;
 //   fill(finnColor);
    fill(this.finnColor);                                  
    triangle(-bodyLength/2, 0,
         -bodyLength/1.5-tailWidth + finnP.x , -tailHeight,   
         -bodyLength/1.5-tailWidth + finnP.x , +tailHeight);  
    // eye
    fill(33, 33, 33);
    ellipse(bodyLength/4, 0, bodyHeight/5, bodyHeight/5);
    // mouth
    fill(245, 33, 33);
    ellipse(bodyLength/4 + 25, 0, 10, 20);
    popMatrix();
};

// Check edges.

 Fish.prototype.checkEdges = function() {

  if (this.position.x > width) {
    this.position.x = 0;
  } else if (this.position.x < 0) {
    this.position.x = width;
  }

  if (this.position.y > height) {
    this.position.y = 0;
  } else if (this.position.y < 0) {
    this.position.y = height;
  }
  
};  

//   SYSTEM
// FishSystem object or class

var FishSystem = function(position) {
    
    this.origin = position.get();
    this.angle = 0 ;            
    this.fishes = [];
   
    // variables for fish
    
    this.bodyLength = 118;
    this.bodyHeight = 74;
    this.bodyColor = color(162, 0, 255);
    this.bodyColor1 = color(213, 255, 0);
    
    // variables for fin

    this.span = 40;
    this.finnColor = color(this.angle, 100, 100) ;
    
};

FishSystem.prototype.addFish = function(origin) {   
    
     this.fishes.push(new Fish(origin));
};

FishSystem.prototype.applyAtracter = function(aPart) {  // aPart is an atracter object , function call from draw() . 
    for(var i = 0; i < this.fishes.length; i++){
        var aFish = this.fishes[i];
        var force = aPart.calculateAtractForce(aFish);  // aFish is a fish object
        aFish.applyForce(force);
    }
};

FishSystem.prototype.applyForce = function(f){      
    for(var i = 0; i < this.fishes.length; i++){
        this.fishes[i].applyForce(f);
    }
};

FishSystem.prototype.run = function(){
	for (var i = this.fishes.length-1; i >= 0; i--) {
        var p = this.fishes[i];

        p.update();
        p.connect();
        
        var beta = this.fishes[i].aPosition * 1.2;          
        var finnP = new PVector(abs(this.span * cos(beta)), -this.span * 0.5 * cos(beta));   
   
        if(i === 0) {
            p.display(this.bodyLength, this.bodyHeight, this.bodyColor, this.fishN, finnP, this.finnColor, this.fishes[i].rotateFish);
        }
        else {
            p.display(this.bodyLength, this.bodyHeight, this.bodyColor1, this.fishN, finnP, this.finnColor, this.fishes[i].rotateFish);
        }
        
    
   fill(245, 191, 191);
        
        p.checkEdges();       
        
    }
};

// end of fish object code

//code for particle objects

var gravity = new PVector(0, 0.01);

var Particle = function(position) {
    this.acceleration = new PVector(0, 0);
    this.velocity = new PVector(random(-1, 1), random(-1, 0));
    this.position = position.get();
    this.timeToLive = 255.0;
    this.mass = random(5, 10);
};

Particle.prototype.calculateAtractForce = function(aFish) { 
    
    var mouth = new PVector((118/4 + 25) * cos(aFish.rotateFish), (118/4 + 25) * sin(aFish.rotateFish));
    var mouthPos = PVector.add(mouth, aFish.position);
    
    var dir1 = PVector.sub(this.position, aFish.position);
    var dir = PVector.sub(this.position, mouthPos);
    var d = dir.mag();
    
    if (d < 5) {                          // delete particle if fish eats it
      this.timeToLive = 0;
    }
                                                                    
    dir.normalize();
    d = constrain(d, 1, 6);                         
    var force = 1 * 60/ (d * d);                          // adjust atraction 60    
    
    
    //   the values returned range from PI to -PI.
    
    var dirAngle = atan2(dir1.y,dir1.x);                    //  giration of fish
    
    if(dirAngle + 0.1  < aFish.rotateFish) {
        aFish.rotateFish -= 0.1;
    }
    else if(dirAngle - 0.1 > aFish.rotateFish) {
        aFish.rotateFish += 0.1;
    }
    
    dir.mult(force); 
    return dir;
};

Particle.prototype.run = function() {
    this.update();
    this.display();
};

Particle.prototype.applyForce = function(force) {
    var f = force.get();
    f.div(this.mass);
    this.acceleration.add(f);
};

Particle.prototype.update = function() {
    this.velocity.add(this.acceleration);
    this.velocity.mult(0.98);
    this.position.add(this.velocity);           
    this.acceleration.mult(0);
    this.timeToLive -= 0.2;
};

// Method to display
Particle.prototype.display = function() {
    stroke(0, 0, 0, this.timeToLive);
    strokeWeight(2);
    fill(255, 0, 0, this.timeToLive);
    ellipse(this.position.x, this.position.y, this.mass, this.mass);
};

Particle.prototype.isDead = function(){
    return this.timeToLive < 0;
};

/*

// object Squid     (sub-class)
                                         //  heading for a sub-object or sub-class.
var Squid = function(position) {
  Particle.call(this, position);         // comma between this and position. 
  this.squidSize = random(15, 30);
};

Squid.prototype = Object.create(Particle.prototype);
Squid.prototype.constructor = Squid;
                                        // end of heading of the sub-class

Squid.prototype.display = function(){
    noStroke();
    imageMode(CENTER);
    var myImage = getImage("avatars/orange-juice-squid");
    image(myImage,this.position.x, this.position.y, this.squidSize, this.squidSize);
    
};

*/

// ParticleSystem object or class

var ParticleSystem = function(position) {          
    this.origin = position.get();
    this.particles = [];
};

ParticleSystem.prototype.addParticle = function(origin) {
    var r = random(1);
    if (r < 0.99) {
        this.particles.push(new Particle(origin));
    } 
    else {
//        this.particles.push(new Squid(origin));    // working
    }
};

ParticleSystem.prototype.applyForce = function(f) {
    for(var i = 0; i < this.particles.length; i++){
        this.particles[i].applyForce(f);
    }
};

ParticleSystem.prototype.applyGravity = function() {
    for(var i = 0; i < this.particles.length; i++) {
        var particleG = gravity.get();
        particleG.mult(this.particles[i].mass);
        this.particles[i].applyForce(particleG);
    }
};

ParticleSystem.prototype.run = function(){
	for (var i = this.particles.length-1; i >= 0; i--) {
        var p = this.particles[i];
        p.run();
        if (p.isDead()) {
            this.particles.splice(i, 1);
        }
    }
};

//end of code for particle objects

//  Main program                                               
                                                           
// Create objects at starting location

// fish part

var fishSystem = new FishSystem(new PVector(width/2, height/2));  

fishSystem.addFish(new PVector(width/2, height/2));       // starting position here 

// variables for particles

var particleSystem = new ParticleSystem(new PVector(width/2, 100));

particleSystem.addParticle(new PVector(width/4 + 25, height/2));         

// end of fish

var timeAdd = 0;

// end of variables for particles

draw = function()  {
    
   background(228, 244, 245); 
   // fish part
   
   if(particleSystem.particles.length >1) {
       fishSystem.applyAtracter(particleSystem.particles[0]);   // start atracter 
   }
  
   fishSystem.run(); 
   
   // particles section
    
    // Time to add particles
    
    if(timeAdd > 1) {
        
        var xX =   new PVector(random(20, width - 20), 100);

        particleSystem.addParticle(xX);

        timeAdd = 0;
        
    }
    timeAdd += 0.005;
    
    particleSystem.applyGravity(gravity);
    particleSystem.run();
    
    fill(0);
    
    // end of particles section

};

var keyPressed = function() {
 
    if (keyCode === LEFT) {    //   turning fish 
    
        var ratPos = new PVector(mouseX, mouseY);
    
        for(var i = 0; i < fishSystem.fishes.length; i++){
    
            var d = PVector.dist(fishSystem.fishes[i].position, ratPos);
    
            if(d < 50) {
            
                fishSystem.fishes[i].rotateFish -= 0.1;       
           
            }
        }
    }  
    else if (keyCode === RIGHT) { //   turning fish 

        var ratPos = new PVector(mouseX, mouseY);
    
        for(var i = 0; i < fishSystem.fishes.length; i++){
    
            var d = PVector.dist(fishSystem.fishes[i].position, ratPos);
    
            if(d < 50) {
            
                fishSystem.fishes[i].rotateFish += 0.1;       
           
            }
        }
    }
    else if (keyCode === UP) {  //   program restart
        Program.restart();        
    }
    else if (keyCode === 90) {  //   slow down fin.
   //     fish.aVelocity = 0.1;    
   
        var ratPos = new PVector(mouseX, mouseY);
    
        for(var i = 0; i < fishSystem.fishes.length; i++){
    
            var d = PVector.dist(fishSystem.fishes[i].position, ratPos);
    
            if(d < 50) {
            
                fishSystem.fishes[i].aVelocity = 0.05; 
           
            }
        }   
    }
};

 // Stop pasting here the code from the Khan place.


    }};

  // Get the canvas that ProcessingJS will use
  var canvas = document.getElementById("mycanvas"); 
  // Pass the function to ProcessingJS constructor
  var processingInstance = new Processing(canvas, programCode); 
  </script>
</html>
